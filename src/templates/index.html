<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DICOM Tools (Rust Version)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { color: #333; font-size: 2em; margin-bottom: 10px; }
        h1::before { content: "ü¶Ä "; /* Swapped to the Rust crab icon :) */ }
        .subtitle { color: #666; font-size: 1.1em; }
        .main-content { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        .panel { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .upload-area { border: 3px dashed #ddd; border-radius: 10px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .upload-area:hover { border-color: #e43b2e; background: #f9f9f9; } /* Rust accent color */
        .upload-area.dragover { border-color: #e43b2e; background: #fff5f5; }
        .btn { background: #e43b2e; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; margin: 5px; transition: all 0.3s; }
        .btn:hover { background: #c22b1e; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #2196F3; }
        .btn-secondary:hover { background: #0b7dda; }
        .btn-danger { background: #f44336; }
        .btn-danger:hover { background: #da190b; }
        #imageView { max-width: 100%; border-radius: 5px; margin-top: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .metadata { margin-top: 15px; }
        .metadata-section { margin-bottom: 15px; }
        .metadata-section h3 { color: #e43b2e; margin-bottom: 10px; font-size: 1.2em; }
        .metadata-item { display: flex; padding: 8px 0; border-bottom: 1px solid #eee; }
        .metadata-item:last-child { border-bottom: none; }
        .metadata-label { font-weight: bold; min-width: 150px; color: #666; }
        .metadata-value { color: #333; word-break: break-all; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        .stat-card { background: #f9f9f9; padding: 15px; border-radius: 5px; text-align: center; }
        .stat-value { font-size: 1.5em; font-weight: bold; color: #e43b2e; }
        .stat-label { color: #666; margin-top: 5px; font-size: 0.9em; }
        .alert { padding: 15px; border-radius: 5px; margin: 15px 0; }
        .alert-success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .alert-error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .alert-warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .loading { display: none; text-align: center; padding: 20px; }
        .loading.active { display: block; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #e43b2e; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        footer { text-align: center; margin-top: 30px; padding: 20px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>DICOM Tools (Rust)</h1>
            <p class="subtitle">Fast web interface for medical imaging workflows</p>
        </header>

        <div class="main-content">
            <div class="panel">
                <h2>üì§ Upload DICOM</h2>
                <div class="upload-area" id="uploadArea">
                    <p style="font-size: 3em; margin-bottom: 10px;">üìÅ</p>
                    <p>Drag and drop a DICOM file here</p>
                    <p style="color: #999; margin: 10px 0;">or</p>
                    <input type="file" id="fileInput" accept=".dcm,.dicom" style="display: none;">
                    <button class="btn" onclick="document.getElementById('fileInput').click()">Choose File</button>
                </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 15px;">Processing...</p>
        </div>

        <div id="fileInfo" style="margin-top: 20px; display: none;">
            <h3>üìã File Information</h3>
            <div class="metadata-item">
                <span class="metadata-label">Patient:</span>
                <span class="metadata-value" id="infoPatient"></span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">Modality:</span>
                <span class="metadata-value" id="infoModality"></span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">Study Date:</span>
                <span class="metadata-value" id="infoStudyDate"></span>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn" onclick="showMetadata()">üìä View Metadata</button>
                <button class="btn btn-secondary" onclick="showStats()">üìà Pixel Stats</button>
                <button class="btn btn-secondary" onclick="anonymize()">üîí Anonymize</button>
                <button class="btn btn-danger" onclick="validate()">‚úì Validate</button>
            </div>
        </div>
    </div>

    <div class="panel">
        <h2>üñºÔ∏è Viewer</h2>
        <div id="viewerContent">
            <p style="text-align: center; color: #999; padding: 60px 20px;">
                Upload a file to view it
            </p>
        </div>
    </div>
        </div>
    </div>

    <footer>
        <p>DICOM Tools v1.0.0 (Rust Version) | Axum & dicom-rs</p>
    </footer>

    <script>
        let currentFilename = null;

    // Drag & drop setup
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) uploadFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) uploadFile(file);
        });

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

        document.getElementById('loading').classList.add('active');
        document.getElementById('fileInfo').style.display = 'none';
        document.getElementById('viewerContent').innerHTML = '<p style="text-align: center; color: #999; padding: 60px 20px;">Loading...</p>';

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    currentFilename = data.filename;
                    
            // Fill basic information
            // The Rust backend should return this 'info' structure in the JSON
            if (data.info) {
                document.getElementById('infoPatient').textContent = data.info.patient_name || 'N/A';
                document.getElementById('infoModality').textContent = data.info.modality || 'N/A';
                document.getElementById('infoStudyDate').textContent = data.info.study_date || 'N/A';
                document.getElementById('fileInfo').style.display = 'block';

                if (data.info.has_pixel_data) {
                    // Timestamp prevents browser caching of the rendered image
                    document.getElementById('viewerContent').innerHTML = 
                        `<img id="imageView" src="/api/image/${data.filename}?t=${new Date().getTime()}" alt="DICOM Image">`;
                } else {
                    document.getElementById('viewerContent').innerHTML = 
                        '<p style="text-align: center; color: #999; padding: 60px 20px;">No pixel data found in this file</p>';
                }
            } else {
                // Fallback if the Rust backend is not returning complete info yet
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('infoPatient').textContent = "Loaded";
                document.getElementById('viewerContent').innerHTML = "<p style='text-align:center'>File uploaded successfully.</p>";
            }

        } else {
            alert('Error: ' + (data.error || 'Upload failed'));
        }
    } catch (error) {
        alert('Upload failed: ' + error.message);
        console.error(error);
            }

            document.getElementById('loading').classList.remove('active');
        }

        async function showMetadata() {
            if (!currentFilename) return;

            try {
                const response = await fetch(`/api/metadata/${currentFilename}`);
                const data = await response.json();

        let html = '<h3>üìã Full Metadata</h3><div class="metadata">';

        // Iterate over categories (Patient, Study, etc.)
        for (const [category, fields] of Object.entries(data)) {
            // Capitalize the category name
            const catTitle = category.charAt(0).toUpperCase() + category.slice(1);
            
            html += `<div class="metadata-section"><h3>${catTitle}</h3>`;
            
            // Ensure fields is an object before iterating
            if (typeof fields === 'object' && fields !== null) {
                for (const [key, value] of Object.entries(fields)) {
                    html += `<div class="metadata-item">
                        <span class="metadata-label">${key}:</span>
                                <span class="metadata-value">${value}</span>
                            </div>`;
                        }
                    }
                    html += '</div>';
                }

                html += '</div>';
                document.getElementById('viewerContent').innerHTML = html;
    } catch (error) {
        alert('Failed to load metadata: ' + error.message);
    }
        }

        async function showStats() {
            if (!currentFilename) return;

    document.getElementById('viewerContent').innerHTML = '<p style="text-align: center; padding: 60px 20px;">Calculating statistics...</p>';

            try {
                const response = await fetch(`/api/stats/${currentFilename}`);
                const data = await response.json();

        let html = '<h3>üìä Pixel Statistics</h3>';
        html += '<div class="stats-grid">';

        const stats = [
            { label: 'Minimum', value: data.min },
            { label: 'Maximum', value: data.max },
            { label: 'Mean', value: data.mean ? data.mean.toFixed(2) : 'N/A' },
            { label: 'Median', value: data.median ? data.median.toFixed(2) : 'N/A' },
            { label: 'Std Dev', value: data.std ? data.std.toFixed(2) : 'N/A' },
            { label: 'Total Pixels', value: data.total_pixels ? data.total_pixels.toLocaleString() : 'N/A' },
        ];

                stats.forEach(stat => {
                    html += `<div class="stat-card">
                        <div class="stat-value">${stat.value}</div>
                        <div class="stat-label">${stat.label}</div>
                    </div>`;
                });

                html += '</div>';
                document.getElementById('viewerContent').innerHTML = html;
    } catch (error) {
        alert('Failed to load statistics: ' + error.message);
        document.getElementById('viewerContent').innerHTML = '<p style="text-align: center; color: red;">Error calculating statistics</p>';
    }
        }

        async function anonymize() {
            if (!currentFilename) return;

    if (!confirm('Anonymize this DICOM file? Patient information will be removed.')) return;

            document.getElementById('loading').classList.add('active');

            try {
                const response = await fetch(`/api/anonymize/${currentFilename}`, { method: 'POST' });
                const data = await response.json();

        if (data.success) {
            alert('File anonymized successfully! Starting download...');
            // Redirect to download
            window.location.href = `/api/download/${data.filename}`;
        } else {
            alert('Error: ' + (data.error || 'Anonymization failed'));
        }
    } catch (error) {
        alert('Anonymization failed: ' + error.message);
    }

            document.getElementById('loading').classList.remove('active');
        }

        async function validate() {
            if (!currentFilename) return;

    document.getElementById('viewerContent').innerHTML = '<p style="text-align: center; padding: 60px 20px;">Validating...</p>';

            try {
                const response = await fetch(`/api/validate/${currentFilename}`);
                const data = await response.json();

        let html = '<h3>‚úì Validation Results</h3>';

        if (data.valid) {
            html += '<div class="alert alert-success">‚úì File is valid!</div>';
        } else {
            html += '<div class="alert alert-error">‚úó Validation failed</div>';
        }

        if (data.errors && data.errors.length > 0) {
            html += '<div class="metadata-section"><h3>Errors</h3>';
            data.errors.forEach(err => {
                html += `<div class="alert alert-error">${err}</div>`;
            });
            html += '</div>';
        }

        if (data.warnings && data.warnings.length > 0) {
            html += '<div class="metadata-section"><h3>Warnings</h3>';
            data.warnings.forEach(warn => {
                html += `<div class="alert alert-warning">${warn}</div>`;
            });
            html += '</div>';
        }
        
        // If there are no errors or warnings
        if ((!data.errors || data.errors.length === 0) && (!data.warnings || data.warnings.length === 0) && data.valid) {
             html += '<p>No errors or warnings found.</p>';
        }

        document.getElementById('viewerContent').innerHTML = html;
    } catch (error) {
        alert('Validation failed: ' + error.message);
    }
}
    </script>
</body>
</html>
